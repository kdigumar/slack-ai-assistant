# ═══════════════════════════════════════════════════════════════════════════════
# KAFKA DEPLOYMENT USING STRIMZI OPERATOR
# ═══════════════════════════════════════════════════════════════════════════════
#
# Prerequisites:
# 1. Install Strimzi Operator:
#    kubectl create namespace kafka
#    kubectl apply -f 'https://strimzi.io/install/latest?namespace=kafka' -n kafka
#
# 2. Wait for the operator to be ready:
#    kubectl wait deployment/strimzi-cluster-operator --for=condition=Available -n kafka
#
# 3. Then apply this file:
#    kubectl apply -f kafka-strimzi.yaml
#
# ═══════════════════════════════════════════════════════════════════════════════

apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: slack-assistant-kafka
  namespace: slack-assistant
spec:
  kafka:
    version: 3.6.0
    replicas: 1  # Use 3 for production
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: false
      - name: tls
        port: 9093
        type: internal
        tls: true
    config:
      offsets.topic.replication.factor: 1  # Use 3 for production
      transaction.state.log.replication.factor: 1
      transaction.state.log.min.isr: 1
      default.replication.factor: 1
      min.insync.replicas: 1
      log.retention.hours: 168  # 7 days
      log.segment.bytes: 1073741824
    storage:
      type: jbod
      volumes:
        - id: 0
          type: persistent-claim
          size: 10Gi
          deleteClaim: false
    resources:
      requests:
        memory: 512Mi
        cpu: 250m
      limits:
        memory: 1Gi
        cpu: 500m
  zookeeper:
    replicas: 1  # Use 3 for production
    storage:
      type: persistent-claim
      size: 5Gi
      deleteClaim: false
    resources:
      requests:
        memory: 256Mi
        cpu: 100m
      limits:
        memory: 512Mi
        cpu: 250m
  entityOperator:
    topicOperator: {}
    userOperator: {}
---
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: slack-events
  namespace: slack-assistant
  labels:
    strimzi.io/cluster: slack-assistant-kafka
spec:
  partitions: 6
  replicas: 1  # Use 3 for production
  config:
    retention.ms: 604800000  # 7 days
    segment.bytes: 1073741824
    cleanup.policy: delete
---
# ═══════════════════════════════════════════════════════════════════════════════
# ALTERNATIVE: Simple Kafka Deployment (without Strimzi)
# Uncomment if you prefer not to use Strimzi operator
# ═══════════════════════════════════════════════════════════════════════════════
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: kafka
#   namespace: slack-assistant
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: kafka
#   template:
#     metadata:
#       labels:
#         app: kafka
#     spec:
#       containers:
#         - name: kafka
#           image: bitnami/kafka:3.6
#           ports:
#             - containerPort: 9092
#           env:
#             - name: KAFKA_CFG_ZOOKEEPER_CONNECT
#               value: zookeeper:2181
#             - name: ALLOW_PLAINTEXT_LISTENER
#               value: "yes"
#             - name: KAFKA_CFG_LISTENERS
#               value: PLAINTEXT://:9092
#             - name: KAFKA_CFG_ADVERTISED_LISTENERS
#               value: PLAINTEXT://kafka-service:9092
#           resources:
#             requests:
#               memory: "512Mi"
#               cpu: "250m"
#             limits:
#               memory: "1Gi"
#               cpu: "500m"
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   name: kafka-service
#   namespace: slack-assistant
# spec:
#   type: ClusterIP
#   ports:
#     - port: 9092
#       targetPort: 9092
#   selector:
#     app: kafka

